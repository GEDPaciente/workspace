name: 'ðŸŽ›ï¸ Build Modulo'
description: 'Fluxo de atualizaÃ§Ã£o do Modulo'
inputs:
  github_token:
    description: 'Token de acesso ao GitHub'
    required: true
outputs:
  module_version:
    description: 'VersÃ£o do Modulo'
    value: ${{ steps.get_version.outputs.version }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ”’ Verificar GitHub Token
      run: |
        if [ -z "${{ inputs.github_token }}" ]; then
          echo "GitHub Token nÃ£o fornecido."
          exit 1
        else
          echo "GitHub Token estÃ¡ presente."
        fi
      shell: bash

    - name: 'Checkout Parent Repository com SubmÃ³dulos'
      uses: actions/checkout@v3
      with:
        repository: GEDPaciente/mv-ged-parent
        token: ${{ inputs.github_token }}
        path: parent

    - name: 'Set up JDK 17'
      uses: actions/setup-java@v4
      with:
        distribution: 'corretto'
        java-version: '17'

    - name: 'Identificar Nome do SubmÃ³dulo pelo RepositÃ³rio'
      id: identify_module
      run: |
        cd parent
        REPO_NAME=$(basename -s .git $(git config --get remote.origin.url))
        echo "RepositÃ³rio atual: $REPO_NAME"
        MODULE_PATH=$(git config -f .gitmodules --get-regexp "path" | grep "$REPO_NAME" | awk '{print $2}')
        if [ -z "$MODULE_PATH" ]; then
          echo "MÃ³dulo correspondente ao repositÃ³rio '$REPO_NAME' nÃ£o encontrado."
          exit 1
        fi
        echo "SubmÃ³dulo identificado: $MODULE_PATH"
        echo "module_path=$MODULE_PATH" >> $GITHUB_ENV
      shell: bash

    - name: 'Inicializar e Atualizar SubmÃ³dulo Identificado'
      run: |
        cd parent
        git submodule update --init --recursive ${{ env.module_path }}
        cd ..
      shell: bash

    - name: 'Buildar o MÃ³dulo'
      run: |
        cd parent/${{ env.module_path }}
        echo "Iniciando build do mÃ³dulo identificado: ${{ env.module_path }}"
        mvn clean install -DskipTests -q
        echo "Build do mÃ³dulo '${{ env.module_path }}' concluÃ­do."
        cd ../..
      shell: bash

    - name: 'Verificar versÃ£o do mÃ³dulo'
      id: get_version
      run: |
        cd parent/${{ env.module_path }}
        CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "VersÃ£o do mÃ³dulo '${{ env.module_path }}': $CURRENT_VERSION"
        echo "module_version=$CURRENT_VERSION" >> $GITHUB_ENV
      shell: bash
